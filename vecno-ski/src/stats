#!/bin/bash

####################################################################################
###
### Vecno-Miner GPU stats (vecno-ski)
### os.dog integration: @osdog
###
####################################################################################

#	Log format examples:
#	306.83 Mhash/s | Accepted: 50 - Rejected: 0 | Up: 10m 40s | 0 CPU, 8 GPU
#	  GPU[#0 NVIDIA GeForce RTX 3070] 39.19 Mhash/s
#	  GPU[#1 NVIDIA GeForce RTX 3070] 39.92 Mhash/s

#	global variables, don`t change it
####################################################################################
CFG_FILENAME="miner.cfg"
dirname=$(dirname "$0")
[[ -f "$dirname/$CFG_FILENAME" ]] && . $dirname/$CFG_FILENAME

LOG="/dog/log/vecno-ski.log"
GPU_STATS="/run/dog/gpuStats"

algo="vecno"
miner="vecno-ski"

# Get version from log (if available)
version=$(grep -oP 'version \K[0-9.]+' "$LOG" 2>/dev/null | tail -1)
[[ -z "$version" ]] && version="0.3"

# Get GPU count from system stats
gpuCount=0
busid_json='[]'
if [[ -f "$GPU_STATS" ]]; then
    gpuCount=$(jq '.gpu | length' < "$GPU_STATS" 2>/dev/null)
    busid_json=$(jq '[.gpu[].b]' < "$GPU_STATS" 2>/dev/null)
fi
[[ -z "$gpuCount" || "$gpuCount" == "null" ]] && gpuCount=0

# Strip ANSI escape codes from log
strip_ansi() {
    sed 's/\x1b\[[0-9;]*[a-zA-Z]//g; s/\x1b\][^\x07]*\x07//g; s/\r//g'
}

# Parse total hashrate and shares from last summary line
# Format: 306.83 Mhash/s | Accepted: 50 - Rejected: 0 | Up: 10m 40s | 0 CPU, 8 GPU
last_summary=$(cat "$LOG" 2>/dev/null | strip_ansi | grep -E '[0-9.]+ [MGK]?hash/s \| Accepted:' | tail -1)

total_hr=0
total_shares=0
total_rejected=0

if [[ -n "$last_summary" ]]; then
    # Extract hashrate value and unit (e.g., "306.83 Mhash/s")
    hr_match=$(echo "$last_summary" | grep -oE '[0-9.]+ [MGK]?hash/s' | head -1)
    hr_value=$(echo "$hr_match" | awk '{print $1}')
    hr_unit=$(echo "$hr_match" | awk '{print $2}')

    if [[ -n "$hr_value" ]]; then
        # Convert to h/s based on unit
        case "$hr_unit" in
            Mhash/s)
                total_hr=$(echo "$hr_value * 1000000" | bc | cut -d'.' -f1)
                ;;
            Khash/s)
                total_hr=$(echo "$hr_value * 1000" | bc | cut -d'.' -f1)
                ;;
            Ghash/s)
                total_hr=$(echo "$hr_value * 1000000000" | bc | cut -d'.' -f1)
                ;;
            *)
                total_hr=$(echo "$hr_value" | cut -d'.' -f1)
                ;;
        esac
    fi

    # Extract Accepted and Rejected
    total_shares=$(echo "$last_summary" | grep -oP 'Accepted: \K[0-9]+')
    total_rejected=$(echo "$last_summary" | grep -oP 'Rejected: \K[0-9]+')
    [[ -z "$total_shares" ]] && total_shares=0
    [[ -z "$total_rejected" ]] && total_rejected=0
fi

# Parse per-GPU hashrates
# Format:   GPU[#0 NVIDIA GeForce RTX 3070] 39.19 Mhash/s
declare -a hr_data=()

for (( i=0; i < gpuCount; i++ )); do
    # Get last hashrate line for this GPU
    gpu_line=$(cat "$LOG" 2>/dev/null | strip_ansi | grep -E "GPU\[#$i " | tail -1)

    gpu_hr=0
    if [[ -n "$gpu_line" ]]; then
        hr_match=$(echo "$gpu_line" | grep -oE '[0-9.]+ [MGK]?hash/s')
        hr_value=$(echo "$hr_match" | awk '{print $1}')
        hr_unit=$(echo "$hr_match" | awk '{print $2}')

        if [[ -n "$hr_value" ]]; then
            case "$hr_unit" in
                Mhash/s)
                    gpu_hr=$(echo "$hr_value * 1000000" | bc | cut -d'.' -f1)
                    ;;
                Khash/s)
                    gpu_hr=$(echo "$hr_value * 1000" | bc | cut -d'.' -f1)
                    ;;
                Ghash/s)
                    gpu_hr=$(echo "$hr_value * 1000000000" | bc | cut -d'.' -f1)
                    ;;
                *)
                    gpu_hr=$(echo "$hr_value" | cut -d'.' -f1)
                    ;;
            esac
        fi
    fi

    hr_data+=($gpu_hr)
done

# Build JSON arrays
if (( gpuCount == 0 )); then
    hr_json='[]'
else
    hr_json=$(printf '%s\n' "${hr_data[@]}" | jq -R . | jq -s .)
fi

# Get online time from log file creation (birth time)
if [[ -f "$LOG" ]]; then
    # Use birth time (%W) for when miner started
    online=$(stat -c %W "$LOG" 2>/dev/null)
    # Fallback to mtime if birth time not available (returns 0)
    [[ "$online" == "0" || -z "$online" ]] && online=$(stat -c %Y "$LOG" 2>/dev/null)

    # Check if miner is still active (log modified in last 60 seconds)
    mtime=$(stat -c %Y "$LOG" 2>/dev/null)
    now=$(date +%s)
    if (( now - mtime > 60 )); then
        online=""
    fi
fi

data=$(
    jq -n \
        --arg algo "$algo" \
        --arg miner "$miner" \
        --arg ver "$version" \
        --argjson busid "$busid_json" \
        --argjson hr "$hr_json" \
    '{
        $miner,
        $algo,
        $ver,
        total_hr: "'"$total_hr"'",
        total_share: "'"$total_shares"'",
        total_badshare: "'"$total_rejected"'",
        busid: $busid,
        hr: $hr
    }'
)

if [[ -n "$online" ]]; then
    data=$(jq ". += {\"online\": $online}" <<< "$data")
fi

echo "$data" | jq -c
