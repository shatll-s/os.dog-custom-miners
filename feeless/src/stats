#!/bin/bash

algo="feeless"
miner="feeless-miner"

LOG="/dog/log/feeless-miner.log"

# Extract latest hashrate from log
latest_hashrate=$(tail -20 "$LOG" | grep "Hashrate:" | tail -1 | grep -oP 'Hashrate: \K[0-9]+' | tail -n 1)
[[ -z "$latest_hashrate" ]] && latest_hashrate=0

# Calculate uptime based on process start time
uptime_sec=0
miner_pid=$(pgrep -f "node.*miner2.js" | head -1)
if [[ -n "$miner_pid" ]]; then
    start_time=$(stat -c %Y /proc/$miner_pid 2>/dev/null)
    if [[ -n "$start_time" ]]; then
        current_time=$(date +%s)
        uptime_sec=$((current_time - start_time))
    fi
fi

# Create JSON output
jq -n \
    --arg miner "$miner" \
    --arg algo "$algo" \
    --arg total_hr "$latest_hashrate" \
    --arg uptime "$uptime_sec" \
    '{
        miner: $miner,
        algo: $algo,
        total_hr: $total_hr,
        uptime: $uptime
    }' | jq -c
